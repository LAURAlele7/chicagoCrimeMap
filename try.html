<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Chicago Police District Crime Map</title>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://unpkg.com/wellknown@0.5.0/wellknown.js"></script>
<style>
body {
    font-family: sans-serif;
    padding: 20px;
    display: flex;
    flex-direction: column;
}

/* ---------- Controls ---------- */
#controls {
    display: flex;
    align-items: center;
    margin-bottom: 20px;
    gap: 20px;
    height: 50px; /* 增加高度，露出完整文字 */
}
#controls label {
    min-width: 80px;
}
#controls input[type="range"], #controls select {
    flex: 1;
    height: 20px; /* 增加高度 */
}

/* ---------- Map ---------- */
#map-chart {
    width: 700px;
    height: 700px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    background: white;
    position: relative;
}

/* ---------- Pie charts ---------- */
#pie-charts {
    display: flex;
    flex-direction: column;
    height: 700px;
    flex: 1;
    margin-left: 20px;
    gap: 20px;
}
.pie-canvas {
    flex: 1;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    background: white;
}

/* ---------- Tooltip ---------- */
.tooltip {
    position: absolute;
    padding: 6px 10px;
    background: white;
    border: 1px solid #ccc;
    border-radius: 5px;
    pointer-events: none;
    opacity: 0;
}

/* ---------- Map Legend ---------- */
.map-legend {
    position: absolute;
    bottom: 10px;
    left: 10px;
    font-size: 12px;
    background: white;
    padding: 5px;
    border: 1px solid #ccc;
    border-radius: 4px;
}

/* ---------- Pie Legend ---------- */
.pie-legend {
    font-size: 12px;
}
</style>
</head>
<body>

<h2>Chicago Police District Crime Map</h2>

<div id="controls">
    <label for="yearSlider">Year: <span id="yearLabel"></span></label>
    <input type="range" id="yearSlider">
    
    <label for="monthSlider">Month: <span id="monthLabel"></span></label>
    <input type="range" id="monthSlider">
    
    <label for="filterSelect">Filter:</label>
    <select id="filterSelect">
        <option value="total">Total</option>
        <option value="arrested">Arrested</option>
        <option value="unarrested">Unarrested</option>
    </select>
</div>

<div style="display:flex;">
    <div id="map-chart"></div>
    <div id="pie-charts">
        <svg id="domesticPie" class="pie-canvas"></svg>
        <svg id="crimeTypePie" class="pie-canvas"></svg>
    </div>
</div>

<script>
d3.csv("PoliceDistrictDec2012_20251203.csv").then(csvData => {
    const features = csvData.map(row => ({
        type: "Feature",
        properties: { dist_num: +row.DIST_NUM, dist_label: row.DIST_LABEL },
        geometry: wellknown.parse(row.the_geom)
    }));
    const geojsonData = { type: "FeatureCollection", features: features };

    d3.json("data_2014_2024/map_pie_data_monthly.json").then(mapData => {
        createD3CrimeMap(mapData, geojsonData);
    });
});

function createD3CrimeMap(mapData, geojsonData) {
    const width = 700, height = 700;
    const container = d3.select("#map-chart");
    container.selectAll("*").remove();
    const svg = container.append("svg").attr("width", width).attr("height", height);

    const projection = d3.geoIdentity().reflectY(true).fitSize([width,height], geojsonData);
    const path = d3.geoPath(projection);
    const colorScale = d3.scaleSequential(d3.interpolateOrRd);

    const tooltip = d3.select("body").append("div").attr("class","tooltip");

    let selectedDistrict = null;
    const yearSlider = document.getElementById("yearSlider");
    const monthSlider = document.getElementById("monthSlider");
    const filterSelect = document.getElementById("filterSelect");
    const yearLabel = document.getElementById("yearLabel");
    const monthLabel = document.getElementById("monthLabel");

    const rawMonths = Object.keys(mapData.monthly_data).sort();
    const parsed = rawMonths.map(k=>{const [y,m]=k.split("-"); return {key:k,year:y,month:m};});
    const years = [...new Set(parsed.map(d=>d.year))];
    yearSlider.min = years[0]; yearSlider.max = years[years.length-1]; yearSlider.value = years[0]; yearLabel.textContent=yearSlider.value;
    monthSlider.min = 1; monthSlider.max = 12; monthSlider.step=1; monthSlider.value = 1; monthLabel.textContent=monthSlider.value;

    function updateMap() {
        const y = yearSlider.value, m = monthSlider.value.toString().padStart(2,"0"), filter = filterSelect.value;
        monthLabel.textContent = monthSlider.value;
        const key = `${y}-${m}`;
        const monthData = mapData.monthly_data[key]; if(!monthData) return;
        
        const crimeByDist = {};
        monthData.forEach(d => {
            crimeByDist[d.District] = d.total_crimes;
        });
        const values = Object.values(crimeByDist);
        colorScale.domain([0,d3.max(values)]);

        svg.selectAll("path").data(geojsonData.features).join("path")
            .attr("d", d=>path(d))
            .attr("stroke","#333").attr("stroke-width",0.5)
            .attr("fill", d=>{
                const dist=d.properties.dist_num;
                const crime=crimeByDist[dist]||0;
                if(selectedDistrict && dist!==selectedDistrict) return "#eee";
                return colorScale(crime);
            })
            .on("mouseover", function(event,d){
                const dist=d.properties.dist_num;
                const crime=crimeByDist[dist]||0;
                tooltip.style("opacity",1)
                    .html(`<b>District ${dist}</b><br>Total: ${crime}`);
                d3.select(this).attr("stroke-width",2);
            })
            .on("mousemove", event=>{tooltip.style("left",(event.pageX+10)+"px").style("top",(event.pageY-20)+"px");})
            .on("mouseout", function(){tooltip.style("opacity",0); d3.select(this).attr("stroke-width",0.5);})
            .on("click", function(event,d){
                const dist=d.properties.dist_num;
                selectedDistrict = selectedDistrict===dist? null: dist;
                updateMap();
                updatePies();
            });

        drawMapLegend(svg, width-650, 350, colorScale);
        updatePies();
    }

    function drawMapLegend(svg, x, y, colorScale){
        const legendHeight = 200, legendWidth = 20;
        const legendScale = d3.scaleLinear().domain(colorScale.domain()).range([legendHeight,0]);
        const legendAxis = d3.axisRight(legendScale).ticks(5);
        const defs = svg.append("defs");
        const linearGradient = defs.append("linearGradient").attr("id","mapGradient").attr("x1","0%").attr("y1","100%").attr("x2","0%").attr("y2","0%");
        linearGradient.selectAll("stop").data(d3.range(0,1.01,0.01)).join("stop")
            .attr("offset",d=>d).attr("stop-color",d=>colorScale(colorScale.domain()[0]*(1-d)+colorScale.domain()[1]*d));
        svg.selectAll(".legend").remove();
        svg.append("g").attr("class","legend").attr("transform",`translate(${x},${y})`)
            .append("rect").attr("width",legendWidth).attr("height",legendHeight).style("fill","url(#mapGradient)");
        svg.select(".legend").append("g").attr("transform",`translate(${legendWidth},0)`).call(legendAxis);
    }

    function updatePies(){
        const y = yearSlider.value, m = monthSlider.value.toString().padStart(2,"0"), filter = filterSelect.value;
        const key = `${y}-${m}`;
        let cityData = mapData.city_level[key];
        if(selectedDistrict){
            const districtRecords = mapData.district_data[selectedDistrict];
            cityData = { ...cityData };
            cityData.total_crimes = districtRecords[0].total_crimes;
            cityData.arrested_crime_type_percentages = {
                weapons_violation: districtRecords[0].weapons_violation_arrested_percentage,
                narcotics: districtRecords[0].narcotics_arrested_percentage,
                criminal_sexual_assault: districtRecords[0].criminal_sexual_assault_arrested_percentage
            };
        }
        drawPie("#domesticPie", [{label:"Domestic", value:cityData.domestic_percentage},{label:"Non-Domestic", value:100-cityData.domestic_percentage}]);
        drawPie("#crimeTypePie", Object.entries(cityData.arrested_crime_type_percentages).map(([k,v])=>({label:k.replace("_"," "), value:v})));
    }

    function drawPie(selector, data){
        const svg = d3.select(selector);
        const width = +svg.attr("width") || svg.node().clientWidth;
        const height = +svg.attr("height") || svg.node().clientHeight;
        const radius = Math.min(width,height)/2 -10;
        svg.selectAll("*").remove();
        const g = svg.append("g").attr("transform",`translate(${radius + 50},${height/2})`);
        const pie = d3.pie().sort(null).value(d=>d.value);
        const arc = d3.arc().innerRadius(radius*0.5).outerRadius(radius);
        const color = d3.scaleOrdinal(d3.schemeCategory10);
        const arcs = g.selectAll("path").data(pie(data)).join("path")
            .attr("d", arc)
            .attr("fill", d=>color(d.data.label))
            .each(function(d){this._current=d;})
            .on("mouseover", function(event,d){
                tooltip.style("opacity",1).html(`${d.data.label}: ${d.data.value.toFixed(2)}%`);
            })
            .on("mousemove", event=>{tooltip.style("left",(event.pageX+10)+"px").style("top",(event.pageY-20)+"px");})
            .on("mouseout", ()=>{tooltip.style("opacity",0);})
            .transition().duration(1000)
            .attrTween("d", function(d){
                const i=d3.interpolate({startAngle:0,endAngle:0},d);
                return t=>arc(i(t));
            });

        // legend
        const legend = svg.append("g").attr("transform",`translate(${width - 200},10)`);
        data.forEach((d,i)=>{
            const gLegend = legend.append("g").attr("transform",`translate(0,${i*20})`);
            gLegend.append("rect").attr("width",12).attr("height",12).attr("fill",color(d.label));
            gLegend.append("text").attr("x",18).attr("y",12).text(d.label);
        });
    }

    yearSlider.addEventListener("input", updateMap);
    monthSlider.addEventListener("input", updateMap);
    filterSelect.addEventListener("change", updateMap);

    updateMap();
}
</script>

</body>
</html>
