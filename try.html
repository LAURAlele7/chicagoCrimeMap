<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Chicago Police District Abstract Crime Map</title>

    <!-- D3 -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <!-- WKT → GeoJSON -->
    <script src="https://unpkg.com/wellknown@0.5.0/wellknown.js"></script>

    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
            display: flex;
            gap: 30px;
        }

        /* 左侧：地图 */
        #map-chart {
            width: 700px;
            height: 700px;
            background: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        }

        /* 右侧：两个饼图 */
        #pie-container {
            width: 380px;
        }
        .pie-box {
            width: 380px;
            height: 330px;
            margin-bottom: 20px;
        }

        select {
            padding: 6px;
            border: 1px solid #ccc;
            margin-left: 10px;
        }

        .slider-row {
            margin-bottom: 12px;
        }
    </style>
</head>

<body>

    <!-- 左侧标题 -->
    <div>
        <h2>Chicago Police District Crime Map</h2>

        <!-- ---------------------- 新增 Arrest Filter ---------------------- -->
        <div style="margin-bottom:10px; display:flex; align-items:center;">
            <label>Crime Type Filter:</label>
            <select id="arrestFilter">
                <option value="total">Total</option>
                <option value="arrested">Arrested</option>
                <option value="unarrested">Unarrested</option>
            </select>
        </div>

        <!-- Sliders -->
        <div class="slider-row" style="display:flex; align-items:center;">
            <div style="flex:1;">
                <label>Year: <span id="yearLabel"></span></label>
                <input type="range" id="yearSlider">
            </div>

            <div style="flex:1; margin-left:15px;">
                <label>Month: <span id="monthLabel"></span></label>
                <input type="range" id="monthSlider">
            </div>
        </div>

        <div id="map-chart"></div>
    </div>

    <!-- 右侧：饼图区域 -->
    <div id="pie-container">
        <h3>Domestic</h3>
        <svg id="pie-domestic" class="pie-box"></svg>

        <h3>Crime Type %</h3>
        <svg id="pie-crimetype" class="pie-box"></svg>
    </div>


<script>

// ====================================================================
//  load police GeoJSON
// ====================================================================
d3.csv("PoliceDistrictDec2012_20251203.csv").then(csvData => {
    const features = csvData.map(row => ({
        type: "Feature",
        properties: {
            dist_num: +row.DIST_NUM,
            dist_label: row.DIST_LABEL
        },
        geometry: wellknown.parse(row.the_geom)
    }));

    const geojsonData = { type: "FeatureCollection", features };

    d3.json("data_2014_2024/map_pie_data_monthly.json").then(mapData => {
        createD3CrimeMap(mapData, geojsonData);
    });
});



// ====================================================================
// MAIN FUNCTION
// ====================================================================
function createD3CrimeMap(mapData, geojsonData) {

    // ------------------------------------------------------------
    //  Parse months
    // ------------------------------------------------------------
    const rawMonths = Object.keys(mapData.monthly_data).sort();
    const parsed = rawMonths.map(k => {
        const [y,m] = k.split("-");
        return { key:k, year:y, month:m };
    });

    const years = [...new Set(parsed.map(d => d.year))];

    const yearSlider = document.getElementById("yearSlider");
    const monthSlider = document.getElementById("monthSlider");
    const yearLabel = document.getElementById("yearLabel");
    const monthLabel = document.getElementById("monthLabel");
    const arrestFilter = document.getElementById("arrestFilter");

    yearSlider.min = years[0];
    yearSlider.max = years[years.length-1];
    yearSlider.value = years[0];
    yearLabel.textContent = yearSlider.value;

    function refreshMonthSlider(year){
        const months = parsed.filter(d => d.year === year).map(d => +d.month);
        monthSlider.min = 1;
        monthSlider.max = 12;
        monthSlider.value = months[0];
        monthLabel.textContent = monthSlider.value;
    }

    refreshMonthSlider(yearSlider.value);

    let currentYear = +yearSlider.value;
    let currentMonth = +monthSlider.value;
    let currentDistrict = null;   // <<<新增：地图点击后的 district

    // ------------------------------------------------------------
    // Draw Map
    // ------------------------------------------------------------
    const width = 700, height = 700;
    const svg = d3.select("#map-chart").append("svg")
        .attr("width", width).attr("height", height);

    const projection = d3.geoIdentity().reflectY(true)
        .fitSize([width,height], geojsonData);

    const path = d3.geoPath(projection);
    const colorScale = d3.scaleSequential(d3.interpolateOrRd);

    // Tooltip
    const tooltip = d3.select("body").append("div")
        .style("position","absolute")
        .style("padding","6px 10px")
        .style("background","white")
        .style("border","1px solid #ccc")
        .style("pointer-events","none")
        .style("opacity",0);


    // ------------------------------------------------------------
    // PIE CHART SETUP
    // ------------------------------------------------------------
    const pieGenerator = d3.pie().value(d => d.value);
    const arcGenerator = d3.arc().innerRadius(0).outerRadius(150);

    const pieDomestic = d3.select("#pie-domestic");
    const pieCrime = d3.select("#pie-crimetype");

    function drawDomesticPie(data){
        const dataset = [
            {label:"Domestic", value:data.domestic},
            {label:"Non-Domestic", value:data.total - data.domestic}
        ];

        const arcs = pieDomestic.selectAll("path")
            .data(pieGenerator(dataset));

        arcs.join("path")
            .attr("transform","translate(180,160)")
            .attr("d", arcGenerator)
            .attr("fill",(d,i)=>["#ff7043","#90caf9"][i]);
    }

    function drawCrimePie(data){
        const dataset = [
            {label:"Weapons", value:data.weapons},
            {label:"Narcotics", value:data.narcotics},
            {label:"Sexual Assault", value:data.sexual}
        ];

        const arcs = pieCrime.selectAll("path")
            .data(pieGenerator(dataset));

        arcs.join("path")
            .attr("transform","translate(180,160)")
            .attr("d", arcGenerator)
            .attr("fill",(d,i)=>["#ef5350","#66bb6a","#42a5f5"][i]);
    }



    // ------------------------------------------------------------
    // Update Pie Charts (City-level or District-level)
    // ------------------------------------------------------------
    function updatePies(year, month, district){
        const key = `${year}-${String(month).padStart(2,"0")}`;

        let src;

        if(district){
            // district-level
            src = mapData.monthly_data[key]
                .find(d => d.District == district);

        } else {
            // city-level
            src = mapData.city_level[key];
        }

        if(!src) return;

        // domestic pie
        drawDomesticPie({
            total: src.total_crimes,
            domestic: src.Domestic ?? Math.round(src.total_crimes * (src.domestic_percentage/100))
        });

        // crime type pie (filter-aware)
        const f = arrestFilter.value; // total / arrested / unarrested

        drawCrimePie({
            weapons: src[`weapons_violation_${f}`] ?? 0,
            narcotics: src[`narcotics_${f}`] ?? 0,
            sexual: src[`criminal_sexual_assault_${f}`] ?? 0
        });
    }



    // ------------------------------------------------------------
    // Update Map
    // ------------------------------------------------------------
    function updateMap(year, month){
        const mm = String(month).padStart(2,"0");
        const key = `${year}-${mm}`;
        const monthData = mapData.monthly_data[key];
        if(!monthData) return;

        const filter = arrestFilter.value; // total/arrested/unarrested

        const crimeByDist = {};
        monthData.forEach(d => {
            crimeByDist[d.District] = d[`narcotics_${filter}`] +
                                       d[`weapons_violation_${filter}`] +
                                       d[`criminal_sexual_assault_${filter}`];
        });

        const vals = Object.values(crimeByDist);
        colorScale.domain([0, d3.max(vals)]);

        svg.selectAll("path")
            .data(geojsonData.features)
            .join("path")
            .attr("d", d => path(d))
            .attr("stroke","#333")
            .attr("stroke-width", d => (d.properties.dist_num === currentDistrict ? 3 : 0.5))
            .attr("fill", d => {
                const dist = d.properties.dist_num;
                const v = crimeByDist[dist] || 0;
                // dim others when a district selected
                return currentDistrict && currentDistrict !== dist
                       ? d3.interpolateOrRd(colorScale(v)).replace("rgb","rgba").replace(")",",0.3)")
                       : colorScale(v);
            })
            .style("cursor","pointer")
            .on("mouseover", function(evt,d){
                const dist = d.properties.dist_num;
                const v = crimeByDist[dist] || 0;
                tooltip.style("opacity",1).html(
                    `<b>District ${dist}</b><br>
                     Crimes: ${v}<br>
                     ${year}-${mm}`
                );
            })
            .on("mousemove", evt=>{
                tooltip.style("left",(evt.pageX+10)+"px")
                       .style("top",(evt.pageY-20)+"px");
            })
            .on("mouseout", ()=> tooltip.style("opacity",0))
            .on("click", (evt, d)=>{
                const dist = d.properties.dist_num;
                currentDistrict = (currentDistrict === dist ? null : dist);
                updateMap(year, month);
                updatePies(year, month, currentDistrict);
            });

        updatePies(year, month, currentDistrict);
    }


    // ------------------------------------------------------------
    // Event listeners
    // ------------------------------------------------------------
    yearSlider.addEventListener("input", ()=>{
        currentYear = +yearSlider.value;
        yearLabel.textContent = currentYear;
        refreshMonthSlider(currentYear);
        currentMonth = +monthSlider.value;
        updateMap(currentYear, currentMonth);
    });

    monthSlider.addEventListener("input", ()=>{
        currentMonth = +monthSlider.value;
        monthLabel.textContent = currentMonth;
        updateMap(currentYear, currentMonth);
    });

    arrestFilter.addEventListener("change", ()=>{
        updateMap(currentYear, currentMonth);
    });

    // Initial draw
    updateMap(currentYear, currentMonth);
}

</script>

</body>
</html>
