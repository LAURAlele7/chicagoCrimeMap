<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Chicago Police District Abstract Crime Map</title>

    <!-- D3 -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <!-- WKT → GeoJSON -->
    <script src="https://unpkg.com/wellknown@0.5.0/wellknown.js"></script>

    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
        }
        #map-chart {
            width: 700px;
            height: 700px;
            background: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        }
        select {
            padding: 8px;
            border: 1px solid #ccc;
            box-sizing: border-box;
        }
        .slider-container {
            margin: 10px 0;
            display: flex;
            align-items: center;
        }

        .slider-container label {
            min-width: 80px; /* 给 label 留空间显示文本 */
        }

        .slider-container input[type="range"] {
            flex: 1;          /* 占满剩余宽度 */
            margin-left: 10px; 
            height: 12px;
            background: #ddd;
            border-radius: 6px;
            outline: none;
        }

        /* slider thumb */
        .slider-container input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: #ff5722;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid #333;
            margin-top: -3px; /* 使 thumb 居中 */
        }

        .slider-container input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: #ff5722;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid #333;
        }
    </style>
</head>

<body>

    <h2>Chicago Police District Crime Map</h2>

    <div class="slider-row" style="display:flex; align-items:center; margin-bottom:10px;">
        <div style="flex:1; display:flex; align-items:center; margin-right:10px;">
            <label for="yearSlider" style="min-width:50px;">Year: <span id="yearLabel"></span></label>
            <input type="range" id="yearSlider" style="flex:1;">
        </div>
        <div style="flex:1; display:flex; align-items:center;">
            <label for="monthSlider" style="min-width:50px;">Month: <span id="monthLabel"></span></label>
            <input type="range" id="monthSlider" style="flex:1;">
        </div>
    </div>


    <div id="map-chart"></div>
    
    <script>

        // =======================================================
        // 1. Load CSV (police districts)
        // =======================================================
        d3.csv("PoliceDistrictDec2012_20251203.csv").then(csvData => {

            // Convert CSV rows → GeoJSON features
            const features = csvData.map(row => ({
                type: "Feature",
                properties: {
                    dist_num: +row.DIST_NUM,
                    dist_label: row.DIST_LABEL
                },
                geometry: wellknown.parse(row.the_geom)
            }));

            const geojsonData = {
                type: "FeatureCollection",
                features: features
            };

            // =======================================================
            // 2. Load crime data JSON (you must provide file or variable)
            // =======================================================
            d3.json("data_2014_2024/map_pie_data_monthly.json").then(mapData => {

                // Call the main map-drawing function
                createD3CrimeMap(mapData, geojsonData);

            });
        });
        document.getElementById("yearSlider").addEventListener("input", function() {
            const y = +this.value;
            const m = +document.getElementById("monthSlider").value; // 保留原值不变
            updateMap(y, m);
        });
        document.getElementById("monthSlider").addEventListener("input", function() {
            const m = +this.value; // 保持数字，不要 padStart
            const y = +document.getElementById("yearSlider").value;
            updateMap(y, m);
        });

        // =======================================================
        // 3. Your createD3CrimeMap() function (modified for CSV GeoJSON)
        // =======================================================
        async function createD3CrimeMap(mapData, geojsonData) {

            // ---------- 1. Parse year/month ----------
            const rawMonths = Object.keys(mapData.monthly_data).sort();

            // Extract years & months separately
            const parsed = rawMonths.map(key => {
                const [year, month] = key.split("-");
                return {
                    key: key,
                    year: year,
                    month: month
                };
            });

            // Unique years
            const years = [...new Set(parsed.map(d => d.year))];

             // DOM elements
            const yearSlider = document.getElementById("yearSlider");
            const monthSlider = document.getElementById("monthSlider");
            const yearLabel = document.getElementById("yearLabel");
            const monthLabel = document.getElementById("monthLabel");

            // Year slider setup
            yearSlider.min = years[0];
            yearSlider.max = years[years.length - 1];
            yearSlider.value = years[0];
            yearLabel.textContent = yearSlider.value;

            // Month slider setup function
            function refreshMonthSlider(year) {
                const months = parsed
                    .filter(d => d.year === year)
                    .map(d => +d.month);

                monthSlider.min = 1;
                monthSlider.max = 12;
                monthSlider.step = 1;
                // monthSlider.value = months[0];

                monthLabel.textContent = monthSlider.value; //.padStart(2, "0");
            }
            let currentYear = +yearSlider.value;
            refreshMonthSlider(currentYear);
            let currentMonth = +monthSlider.value;


            // ---------- SVG setup ----------
            const width = 700;
            const height = 700;

            const container = d3.select("#map-chart");
            container.selectAll("*").remove();

            const svg = container.append("svg")
                .attr("width", width)
                .attr("height", height);

            const projection = d3.geoIdentity()
                .reflectY(true)
                .fitSize([width, height], geojsonData);

            const path = d3.geoPath(projection);

            const colorScale = d3.scaleSequential(d3.interpolateOrRd);

            const tooltip = d3.select("body")
                .append("div")
                .style("position", "absolute")
                .style("padding", "6px 10px")
                .style("background", "white")
                .style("border", "1px solid #ccc")
                .style("border-radius", "5px")
                .style("pointer-events", "none")
                .style("opacity", 0);


            // ---------- 2. DRAW MAP ----------
            function updateMap(y, m) {
                const mm = String(m).padStart(2, "0");
                const key = `${y}-${mm}`;

                const monthData = mapData.monthly_data[key];
                if (!monthData) return;

                const crimeByDist = {};

                monthData.forEach(d => {
                    crimeByDist[d.District] = d.total_crimes;
                });

                const values = Object.values(crimeByDist);
                colorScale.domain([0, d3.max(values)]);

                svg.selectAll("path")
                    .data(geojsonData.features)
                    .join("path")
                    .attr("d", d => path(d))
                    .attr("stroke", "#333")
                    .attr("stroke-width", 0.5)
                    .attr("fill", d => {
                        const dist = d.properties.dist_num;
                        const crime = crimeByDist[dist] || 0;
                        return colorScale(crime);
                    })
                    .on("mouseover", function(event, d) {
                        const dist = d.properties.dist_num;
                        const crime = crimeByDist[dist] || 0;

                        tooltip.style("opacity", 1)
                            .html(
                                `<b>District ${dist}</b><br>` +
                                `Crimes: ${crime}<br>` +
                                `Year: ${y}<br>` +
                                `Month: ${mm}`
                            );

                        d3.select(this).attr("stroke-width", 2);
                    })
                    .on("mousemove", event => {
                        tooltip.style("left", (event.pageX + 10) + "px")
                            .style("top", (event.pageY - 20) + "px");
                    })
                    .on("mouseout", function() {
                        tooltip.style("opacity", 0);
                        d3.select(this).attr("stroke-width", 0.5);
                    });
            }

            // initial draw
            updateMap(currentYear, currentMonth);

            // ---------- 3. Event listeners ----------
            yearSlider.addEventListener("input", () => {
                currentYear = +yearSlider.value;
                yearLabel.textContent = currentYear;
                refreshMonthSlider(currentYear);
                currentMonth = +monthSlider.value;
                updateMap(currentYear, currentMonth);
            });

            monthSlider.addEventListener("input", () => {
                currentMonth = +monthSlider.value;
                monthLabel.textContent = currentMonth;
                updateMap(currentYear, currentMonth);
            });

        }

    </script>

</body>
</html>
